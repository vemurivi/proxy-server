import { Component } from '@angular/core';
import { Observable, combineLatest, map } from 'rxjs';
import { Store } from '@ngrx/store';
import { WeeklySummaryColumns, WeeklySummaryStaffing, WeeklySummarySmalls, WeeklySummaryIrregulars } from './models';
import { fromWeeklySummaryStore } from './store';

@Component({
  selector: 'app-weekly-summary',
  templateUrl: './weekly-summary.component.html',
})
export class WeeklySummaryComponent {
  // HOURS
  showHours$ = this.store.select(fromWeeklySummaryStore.getColVisibility(WeeklySummaryColumns.Hours));
  showTotalHours$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Hours, 'Total'));
  showDirectHours$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Hours, 'Direct'));
  showIndirectHours$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Hours, 'Indirect'));

  hoursHeaderClass$: Observable<string> = combineLatest([
    this.showHours$,
    this.showTotalHours$,
    this.showDirectHours$,
    this.showIndirectHours$
  ]).pipe(
    map(([main, total, direct, indirect]) => {
      if (!main) return 'header-cell-0';
      const count = [total, direct, indirect].filter(Boolean).length;
      return `header-cell-${count}`;
    })
  );

  // STAFFING
  showStaffing$ = this.store.select(fromWeeklySummaryStore.getColVisibility(WeeklySummaryColumns.Staffing));
  showAssignedStaffing$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Staffing, WeeklySummaryStaffing.Assigned));
  showWorkedStaffing$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Staffing, WeeklySummaryStaffing.Worked));
  showAbsentStaffing$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Staffing, WeeklySummaryStaffing.Absent));
  showLessThanThree$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Staffing, WeeklySummaryStaffing.LessThenThree));
  showGreaterThanFive$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Staffing, WeeklySummaryStaffing.GreaterThenFive));
  showGreaterThanEight$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Staffing, WeeklySummaryStaffing.GreaterThenEight));

  staffingHeaderClass$: Observable<string> = combineLatest([
    this.showStaffing$,
    this.showAssignedStaffing$,
    this.showWorkedStaffing$,
    this.showAbsentStaffing$,
    this.showLessThanThree$,
    this.showGreaterThanFive$,
    this.showGreaterThanEight$
  ]).pipe(
    map(([main, assigned, worked, absent, lessThree, greaterFive, greaterEight]) => {
      if (!main) return 'header-cell-0';
      const count = [assigned, worked, absent, lessThree, greaterFive, greaterEight].filter(Boolean).length;
      return `header-cell-${count}`;
    })
  );

  // SMALLS
  showSmalls$ = this.store.select(fromWeeklySummaryStore.getColVisibility(WeeklySummaryColumns.Smalls));
  showSmallsPercent$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Smalls, WeeklySummarySmalls.SmallsPercent));
  showSmallsVolume$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Smalls, WeeklySummarySmalls.SmallsVolume));
  showSmallsPPH$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Smalls, WeeklySummarySmalls.SmallsPPH));

  smallsHeaderClass$: Observable<string> = combineLatest([
    this.showSmalls$,
    this.showSmallsPercent$,
    this.showSmallsVolume$,
    this.showSmallsPPH$
  ]).pipe(
    map(([main, percent, volume, pph]) => {
      if (!main) return 'header-cell-0';
      const count = [percent, volume, pph].filter(Boolean).length;
      return `header-cell-${count}`;
    })
  );

  // IRREGULARS
  showIrregulars$ = this.store.select(fromWeeklySummaryStore.getColVisibility(WeeklySummaryColumns.Irregulars));
  showIrregPercent$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Irregulars, WeeklySummaryIrregulars.IrregPercent));
  showIrregVolume$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Irregulars, WeeklySummaryIrregulars.IrregVolume));
  showIrregPPH$ = this.store.select(fromWeeklySummaryStore.getSubColVisibility(WeeklySummaryColumns.Irregulars, WeeklySummaryIrregulars.IrregPPH));

  irregularsHeaderClass$: Observable<string> = combineLatest([
    this.showIrregulars$,
    this.showIrregPercent$,
    this.showIrregVolume$,
    this.showIrregPPH$
  ]).pipe(
    map(([main, percent, volume, pph]) => {
      if (!main) return 'header-cell-0';
      const count = [percent, volume, pph].filter(Boolean).length;
      return `header-cell-${count}`;
    })
  );

  constructor(private store: Store) {}
}